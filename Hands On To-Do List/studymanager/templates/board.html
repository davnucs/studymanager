{% extends "base.html" %} {% block title %}{{ board.name }}{% endblock %} {%
block content %}
<h2>{{ board.name }}</h2>
<div class="d-flex overflow-auto" id="board-container">
  {% for list in board.lists %}
  <div class="card me-3" style="min-width: 300px">
    <div class="card-header">{{ list.name }}</div>
    <div class="card-body" id="list-{{ list.id }}" data-list-id="{{ list.id }}">
      {% for card in list.cards %}
      <div
        class="card mb-2"
        id="card-{{ card.id }}"
        data-card-id="{{ card.id }}"
      >
        <div class="card-body">
          <h6>
            {{ card.title }}{% if card.completed %} âœ“{% endif %}{% if
            card.reminder %} ðŸ””{% endif %}
          </h6>
          <p>Due: {{ card.due_date or 'N/A' }}</p>
          <a
            href="{{ url_for('edit_card', card_id=card.id) }}"
            class="btn btn-sm btn-secondary"
            >Edit</a
          >
          <a
            href="{{ url_for('delete_card', card_id=card.id) }}"
            class="btn btn-sm btn-danger"
            >Delete</a
          >
        </div>
      </div>
      {% endfor %}
    </div>
    <div class="card-footer">
      <form method="post" action="{{ url_for('add_card', list_id=list.id) }}">
        <input
          type="text"
          name="title"
          placeholder="Card Title"
          class="form-control mb-2"
          required
        />
        <textarea
          name="description"
          placeholder="Description"
          class="form-control mb-2"
        ></textarea>
        <input type="date" name="due_date" class="form-control mb-2" />
        <button type="submit" class="btn btn-primary">Add Card</button>
      </form>
    </div>
  </div>
  {% endfor %}
</div>
<!-- Progress Bar for the Board (Dynamic Only) -->
<div class="mt-4">
  <h5>Board Progress</h5>
  <div class="progress">
    <div
      class="progress-bar"
      role="progressbar"
      id="progress-bar"
      style="width: 0%"
      aria-valuenow="0"
      aria-valuemin="0"
      aria-valuemax="100"
    >
      0.0%
    </div>
  </div>
  <p id="progress-text">0/0 cards completed</p>
</div>
{% endblock %} {% block scripts %}
<script>
  // Function to update progress bar
  function updateProgress() {
    fetch("/get_board_progress/{{ board.id }}")
      .then((response) => response.json())
      .then((data) => {
        const progressBar = document.getElementById("progress-bar");
        const progressText = document.getElementById("progress-text");
        progressBar.style.width = data.progress_percent + "%";
        progressBar.setAttribute("aria-valuenow", data.progress_percent);
        progressBar.textContent = data.progress_percent.toFixed(1) + "%";
        progressText.textContent =
          data.completed_cards + "/" + data.total_cards + " cards completed";
      })
      .catch((error) => console.error("Error updating progress:", error));
  }

  // Update progress on page load
  document.addEventListener("DOMContentLoaded", updateProgress);

  document.querySelectorAll('[id^="list-"]').forEach((list) => {
    new Sortable(list, {
      group: "cards",
      animation: 150,
      onEnd: function (evt) {
        const cardId = evt.item.id.split("-")[1];
        const newListId = evt.to.id.split("-")[1];
        const oldListId = evt.from.id.split("-")[1];
        fetch("/move_card", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            card_id: cardId,
            list_id: newListId,
            old_list_id: oldListId,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              // Update card's check mark dynamically
              const h6 = evt.item.querySelector("h6");
              const currentText = h6.textContent;
              const title = currentText
                .replace(" âœ“", "")
                .replace(" ðŸ””", "")
                .trim();
              const hasBell = currentText.includes(" ðŸ””");
              h6.textContent =
                title + (data.completed ? " âœ“" : "") + (hasBell ? " ðŸ””" : "");

              updateProgress(); // Refresh progress after move
            } else {
              alert("Error: " + (data.error || "Unknown error"));
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("An error occurred.");
          });
      },
    });
  });
</script>
{% endblock %}
