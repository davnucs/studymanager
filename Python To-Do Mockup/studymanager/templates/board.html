{% extends "base.html" %} {% block title %}{{ board.name }}{% endblock %} {%
block content %}

<section class="board-section">
  <section class="board-title-container">
    <h2 class="board-title">{{ board.name }}</h2>
  </section>

  <div class="lists-container">
    {% for lst in board.lists|sort(attribute='position') %}
    <section class="list" id="list-{{ lst.id }}" data-list-id="{{ lst.id }}">
      <h3 class="list-name">{{ lst.name }}</h3>

      <!-- Cards container -->
      <div class="cards" id="cards-{{ lst.id }}">
        {% for card in lst.cards|sort(attribute='position') %}
        <div class="card-container" id="card-container-{{ card.id }}">
          <!-- Card display -->
          <div
            class="card{% if card.completed %} completed{% endif %} card-display"
            id="card-display-{{ card.id }}"
            data-card-id="{{ card.id }}"
          >
            <div class="card-title">
              {{ card.title }}{% if card.completed %} âœ“{% endif %}{% if
              card.reminder %} ðŸ””{% endif %}
            </div>
            {% if card.description %}
            <div class="card-desc">{{ card.description }}</div>
            {% endif %} {% if card.due_date %}
            <div class="card-due">Due: {{ card.due_date }}</div>
            {% endif %}
            <div class="card-actions">
              <a
                href="javascript:void(0);"
                class="card-edit"
                onclick="showEditCardForm({{ card.id }})"
                >Edit</a
              >
              <a
                href="{{ url_for('delete_card', card_id=card.id) }}"
                class="card-delete"
                >Delete</a
              >
            </div>
          </div>

          <!-- Inline Edit Card Form, initially hidden -->
          <form
            method="post"
            action="{{ url_for('edit_card', card_id=card.id) }}"
            class="edit-card-form"
            id="edit-form-{{ card.id }}"
            style="display: none"
          >
            <input
              type="text"
              name="title"
              placeholder="Card Title"
              class="card-input title"
              required
            />
            <textarea
              name="description"
              placeholder="Description"
              class="card-input description"
            ></textarea>
            <input type="date" name="due_date" class="card-input due-date" />
            <div class="checkbox-container">
              <input type="checkbox" id="editCompleted" name="completed" />
              <label for="editCompleted">Completed</label>
            </div>
            <button type="submit" class="add-card-btn">Save</button>
            <button
              type="button"
              class="cancel-btn"
              onclick="hideEditCardForm({{ card.id }})"
            >
              Cancel
            </button>
          </form>
        </div>
        {% endfor %}
      </div>

      <!-- Add card form below cards -->
      <form
        method="post"
        action="{{ url_for('add_card', list_id=lst.id) }}"
        class="card-add-form"
        id="form-{{ lst.id }}"
        style="display: none"
      >
        <input
          type="text"
          name="title"
          placeholder="Card Title"
          class="card-input title"
          required
        />
        <textarea
          name="description"
          placeholder="Description"
          class="card-input description"
        ></textarea>
        <input type="date" name="due_date" class="card-input due-date" />
        <button type="submit" class="add-card-btn">Add Card</button>
        <button
          type="button"
          class="cancel-btn"
          onclick="hideAddCardForm({{ lst.id }})"
        >
          Cancel
        </button>
      </form>

      <!-- Add Card button -->
      <button
        class="show-form-btn"
        id="btn-{{ lst.id }}"
        onclick="showAddCardForm({{ lst.id }})"
      >
        + Add Card
      </button>
    </section>
    {% endfor %}
  </div>

  <section class="progress-section">
    <h3>Board Progress</h3>
    <div class="progress-bar-bg">
      <div
        class="progress-bar-fill"
        style="width: {{ board_progress_percent }}%;"
      ></div>
    </div>
    <small
      >{{ completed_cards }}/{{ total_cards }} cards completed ({{
      board_progress_percent }}%)</small
    >
  </section>
</section>
{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  document.querySelectorAll(".cards").forEach((cardsContainer) => {
    new Sortable(cardsContainer, {
      group: "cards",
      animation: 150,
      onEnd: function (evt) {
        const cardId = evt.item.id.replace("card-", "");
        const newListId = evt.to.id.replace("cards-", "");
        const oldListId = evt.from.id.replace("cards-", "");
        fetch("/move_card", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            card_id: cardId,
            list_id: newListId,
            old_list_id: oldListId,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const progressFill = document.querySelector(".progress-bar-fill");
              const progressText = document.querySelector(
                ".progress-section small"
              );
              progressFill.style.width = data.progress_percent + "%";
              progressText.textContent = `${data.completed_cards}/${
                data.total_cards
              } cards completed (${data.progress_percent.toFixed(1)}%)`;

              const cardContainer = document.getElementById(
                "card-container-" + cardId
              );
              const cardTitleEl = cardContainer.querySelector(".card-title");
              const baseTitle = cardTitleEl.textContent
                .replace(" âœ“", "")
                .replace(" ðŸ””", "")
                .trim();
              cardTitleEl.textContent =
                baseTitle +
                (data.completed ? " âœ“" : "") +
                (cardTitleEl.textContent.includes("ðŸ””") ? " ðŸ””" : "");
            } else {
              console.warn("Error moving card:", data.error);
            }
          });
      },
    });
  });

  // Show Add Card form function
  function showAddCardForm(listId) {
    document.getElementById(`form-${listId}`).style.display = "flex";
    document.getElementById(`btn-${listId}`).style.display = "none";
  }

  function hideAddCardForm(listId) {
    document.getElementById(`form-${listId}`).style.display = "none";
    document.getElementById(`btn-${listId}`).style.display = "inline-block";
  }

  // Show Edit Card form replacing the card display
  function showEditCardForm(cardId) {
    const cardContainer = document.getElementById(`card-container-${cardId}`);
    const cardDisplay = cardContainer.querySelector(".card-display");
    const editForm = cardContainer.querySelector(".edit-card-form");

    // Prefill edit form fields from card display content
    const cardTitle = cardDisplay
      .querySelector(".card-title")
      .textContent.replace(" âœ“", "")
      .replace(" ðŸ””", "")
      .trim();
    editForm.querySelector('input[name="title"]').value = cardTitle;

    const descEl = cardDisplay.querySelector(".card-desc");
    editForm.querySelector('textarea[name="description"]').value = descEl
      ? descEl.textContent
      : "";

    const dueEl = cardDisplay.querySelector(".card-due");
    // Format the date as YYYY-MM-DD if needed here
    if (dueEl) {
      const dateText = dueEl.textContent.replace("Due: ", "").trim();
      editForm.querySelector('input[name="due_date"]').value = dateText;
    } else {
      editForm.querySelector('input[name="due_date"]').value = "";
    }

    editForm.querySelector('input[name="completed"]').checked =
      cardDisplay.classList.contains("completed");

    // Update form action attribute
    editForm.action = `/edit_card/${cardId}`;

    // Hide card display and show edit form
    cardDisplay.style.display = "none";
    editForm.style.display = "flex";
  }

  function hideEditCardForm(cardId) {
    const cardContainer = document.getElementById(`card-container-${cardId}`);
    const cardDisplay = cardContainer.querySelector(".card-display");
    const editForm = cardContainer.querySelector(".edit-card-form");

    editForm.style.display = "none";
    cardDisplay.style.display = "block";
  }
</script>
{% endblock %}
