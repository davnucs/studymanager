{% extends "base.html" %} {% block title %}{{ board.name }}{% endblock %} {%
block content %}

<section class="board-section">
  <section class="board-title-container">
    <h2 class="board-title">{{ board.name }}</h2>
  </section>

  <div class="lists-container">
    {% for lst in board.lists|sort(attribute='position') %}
    <section class="list" id="list-{{ lst.id }}" data-list-id="{{ lst.id }}">
      <h3 class="list-name">{{ lst.name }}</h3>

      <!-- Cards container -->
      <div class="cards" id="cards-{{ lst.id }}">
        {% for card in lst.cards|sort(attribute='position') %}
        <div
          class="card{% if card.completed %} completed{% endif %}"
          id="card-{{ card.id }}"
          data-card-id="{{ card.id }}"
        >
          <div class="card-display">
            <div class="card-title">
              {{ card.title }}{% if card.completed %} âœ“{% endif %}{% if
              card.reminder %} ðŸ””{% endif %}
            </div>
            {% if card.description %}
            <div class="card-desc">{{ card.description }}</div>
            {% endif %} {% if card.due_date %}
            <div class="card-due">Due: {{ card.due_date }}</div>
            {% endif %}
            <div class="card-actions">
              <a
                href="javascript:void(0);"
                class="card-edit"
                onclick="showEditCardForm({{ card.id }})"
                >Edit</a
              >
              <a
                href="{{ url_for('delete_card', card_id=card.id) }}"
                class="card-delete"
                >Delete</a
              >
            </div>
          </div>

          <!-- Inline Edit Card Form, initially hidden -->
          <form
            method="post"
            action="{{ url_for('edit_card', card_id=card.id) }}"
            class="edit-card-form"
            id="edit-form-{{ card.id }}"
            style="display: none"
          >
            <input
              type="text"
              name="title"
              placeholder="Card Title"
              class="card-input title"
              required
            />
            <textarea
              name="description"
              placeholder="Description"
              class="card-input description"
            ></textarea>
            <input type="date" name="due_date" class="card-input due-date" />
            <div class="checkbox-container">
              <input
                type="checkbox"
                id="editCompleted-{{ card.id }}"
                name="completed"
              />
              <label for="editCompleted-{{ card.id }}">Completed</label>
            </div>
            <button type="submit" class="add-card-btn">Save</button>
            <button
              type="button"
              class="cancel-btn"
              onclick="hideEditCardForm({{ card.id }})"
            >
              Cancel
            </button>
          </form>
        </div>
        {% endfor %}
      </div>

      <!-- Add Card Button -->
      <button
        class="show-form-btn"
        id="btn-{{ lst.id }}"
        onclick="showAddCardForm({{ lst.id }})"
      >
        + Add Card
      </button>

      <!-- Add card form below cards, initially hidden -->
      <form
        method="post"
        action="{{ url_for('add_card', list_id=lst.id) }}"
        class="card-add-form"
        id="form-{{ lst.id }}"
        style="display: none"
      >
        <input
          type="text"
          name="title"
          placeholder="Card Title"
          class="card-input title"
          required
        />
        <textarea
          name="description"
          placeholder="Description"
          class="card-input description"
        ></textarea>
        <input type="date" name="due_date" class="card-input due-date" />
        <button type="submit" class="add-card-btn">Add Card</button>
        <button
          type="button"
          class="cancel-btn"
          onclick="hideAddCardForm({{ lst.id }})"
        >
          Cancel
        </button>
      </form>
    </section>
    {% endfor %}
  </div>

  <!-- Collapsible Progress Bar Section -->
  <section>
    <div class="progress-header" onclick="toggleProgress()">
      <span>Board Progress</span>
      <span id="arrow" class="arrow">&#9660;</span>
      <!-- Down arrow -->
    </div>
    <div id="progress-content" class="progress-content">
      <div class="progress-bar-bg">
        <div
          class="progress-bar-fill"
          style="width: {{ board_progress_percent }}%;"
        ></div>
      </div>
      <small
        >{{ completed_cards }}/{{ total_cards }} cards completed ({{
        board_progress_percent }}%)</small
      >
    </div>
  </section>
</section>

{% endblock %} {% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  document.querySelectorAll(".cards").forEach((cardsContainer) => {
    new Sortable(cardsContainer, {
      group: "cards",
      animation: 150,
      onEnd: function (evt) {
        const cardId = evt.item.id.replace("card-", "");
        const newListId = evt.to.id.replace("cards-", "");
        const oldListId = evt.from.id.replace("cards-", "");
        fetch("/move_card", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            card_id: cardId,
            list_id: newListId,
            old_list_id: oldListId,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.success) {
              const progressFill = document.querySelector(".progress-bar-fill");
              const progressText = document.querySelector(
                ".progress-content small"
              );
              progressFill.style.width = data.progress_percent + "%";
              progressText.textContent = `${data.completed_cards}/${
                data.total_cards
              } cards completed (${data.progress_percent.toFixed(1)}%)`;

              const cardEl = document.getElementById("card-" + cardId);
              const cardTitleEl = cardEl.querySelector(".card-title");
              const baseTitle = cardTitleEl.textContent
                .replace(" âœ“", "")
                .replace(" ðŸ””", "")
                .trim();
              cardTitleEl.textContent =
                baseTitle +
                (data.completed ? " âœ“" : "") +
                (cardTitleEl.textContent.includes("ðŸ””") ? " ðŸ””" : "");
            } else {
              alert("Error moving card: " + data.error);
            }
          });
      },
    });
  });

  function showAddCardForm(listId) {
    document.getElementById(`form-${listId}`).style.display = "flex";
    document.getElementById(`btn-${listId}`).style.display = "none";
  }

  function hideAddCardForm(listId) {
    document.getElementById(`form-${listId}`).style.display = "none";
    document.getElementById(`btn-${listId}`).style.display = "inline-block";
  }

  function toggleProgress() {
    const content = document.getElementById("progress-content");
    const arrow = document.getElementById("arrow");
    if (content.style.display === "none" || content.style.display === "") {
      content.style.display = "block";
      arrow.innerHTML = "&#9650;"; // Up arrow
    } else {
      content.style.display = "none";
      arrow.innerHTML = "&#9660;"; // Down arrow
    }
  }

  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("progress-content").style.display = "none"; // start collapsed
  });

  function showEditCardForm(cardId) {
    const card = document.getElementById(`card-${cardId}`);
    const cardDisplay = card.querySelector(".card-display");
    const editForm = card.querySelector(".edit-card-form");

    const cardTitle = cardDisplay
      .querySelector(".card-title")
      .textContent.replace(" âœ“", "")
      .replace(" ðŸ””", "")
      .trim();
    editForm.querySelector('input[name="title"]').value = cardTitle;

    const descEl = cardDisplay.querySelector(".card-desc");
    editForm.querySelector('textarea[name="description"]').value = descEl
      ? descEl.textContent
      : "";

    const dueEl = cardDisplay.querySelector(".card-due");
    if (dueEl) {
      const dateText = dueEl.textContent.replace("Due: ", "").trim();
      editForm.querySelector('input[name="due_date"]').value = dateText;
    } else {
      editForm.querySelector('input[name="due_date"]').value = "";
    }

    // set the checkbox with a unique id for each card if necessary
    const editCompletedCheckbox = editForm.querySelector(
      'input[name="completed"]'
    );
    editCompletedCheckbox.checked = card.classList.contains("completed");

    editForm.action = `/edit_card/${cardId}`;

    cardDisplay.style.display = "none";
    editForm.style.display = "flex";
  }

  function hideEditCardForm(cardId) {
    const card = document.getElementById(`card-${cardId}`);
    const cardDisplay = card.querySelector(".card-display");
    const editForm = card.querySelector(".edit-card-form");

    editForm.style.display = "none";
    cardDisplay.style.display = "block";
  }
</script>
{% endblock %}
